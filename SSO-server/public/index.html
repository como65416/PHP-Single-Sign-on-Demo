<html>
<head>
  <meta charset="UTF-8">
  <title>SSO login</title>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/store-js@2.0.4/dist/store.legacy.min.js"></script>
  <script src="/js/main.js"></script>
</head>
<body>
  <div id="login_form">
    <h1>SSO Login</h1>
    Account: <input id="username" type="text"></input></br />
    Password: <input id="password" type="password"></input><br />
    <button onclick="login()">Login</button>
  </div>

  <div id="site_list">
    <h1>SSO Site List</h1>
    <div id="site_links">
    </div>
    <button onclick="logout()">Logout</button>
  </div>
  <script>
    // 取得JWT內容
    function parseJwt (token) {
      var base64Url = token.split('.')[1];
      var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));

      return JSON.parse(jsonPayload);
    };

    // 取得可以登入的網站
    async function getAvailableSites() {
      let response = await axios.get('/api/available-sites', {
          headers: {
            'Authorization': 'Bearer ' + store.get('jwt_token')
          }
        });

      return response.data;
    }

    async function openSite(siteId) {
      let response = await axios.get("/api/to-site", {
          params: {
            siteId: siteId
          },
          headers: {
            'Authorization': 'Bearer ' + store.get('jwt_token')
          }
        });
      location.href = response.data.login_url;
    }

    async function refreshUI() {
      if (isLogin()) {
        document.getElementById('login_form').style.display = "none";
        document.getElementById('site_list').style.display = "";

        let availableSites = await getAvailableSites();
        let html = '';
        for (let site of availableSites) {
          html += '<a href="#" onclick="openSite(' + site.id + ')" />' + site.name + '</a><br />';
        }
        document.getElementById('site_links').innerHTML = html;
      } else {
        document.getElementById('login_form').style.display = "";
        document.getElementById('site_list').style.display = "none";
      }
    }
    refreshUI();
  </script>
</body>
</html>
